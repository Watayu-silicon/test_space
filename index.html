<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リアルタイム信号機マップ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
        }
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: #333;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
        }
        #menu-btn {
            font-size: 24px;
            margin-right: 20px;
            cursor: pointer;
        }
        #map {
            height: calc(100% - 60px);
            width: 100%;
            position: absolute;
            top: 60px;
        }
        #locateMe {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            padding: 10px;
            background-color: white;
            border: none;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            cursor: pointer;
        }
        #signal-info {
            position: fixed;
            bottom: -340px; /* 最初は画面の外にある状態 */
            left: 0;
            right: 0;
            height: 300px;
            background-color: white;
            transition: bottom 0.3s, height 0.3s; /* bottom のアニメーションを追加 */
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1001;
            padding: 20px;
            overflow-y: auto;
        }

        #signal-info.active {
            bottom: -120px; /* ボタンがクリックされると、画面内にスライドイン */
        }

        #signal-info.full {
            bottom: -40px; /* 上方向にスライドし、全画面モードにする */
            height: calc(100% - 60px); /* 全画面モードの高さ */
        }


        .arrow-container {
            position: absolute;
            left: 0%;
            top: -18%;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #display_second_lie {
            left: 10%;
            font-size: 52px;
            position: absolute;
            top: 36%;
            transform-origin: center center;
        }
        #display_second_up {
            left: 45%;
            font-size: 52px;
            position: absolute;
            top: 57%;
            transform-origin: center center;
        }

        .horizontal_arrow {
            background: linear-gradient(90deg, limegreen 100%, antiquewhite 100%);
            width: 160px;
            background-color: antiquewhite;
            transition: background 1s linear;
            height: 8px;
            position: absolute;
        }
        
        .horizontal_arrow::before {
            content: '';
            position: absolute;
            left: -14px;
            top: -6px;
            width: 0;
            height: 0;
            border-right: 20px solid #000;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
        }

        .horizontal_arrow::after {
            content: '';
            position: absolute;
            right: -14px;
            top: -6px;
            width: 0;
            height: 0;
            border-left: 20px solid #000;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
        }

        .vertical_arrow {
            background: linear-gradient(antiquewhite 0%, red 0%);
            width: 8px;
            height: 160px;
            background-color:antiquewhite;
            transition: background 1s linear;
            position: absolute;
        }
        
        .vertical_arrow::before {
            content: '';
            position: absolute;
            bottom: -14px;
            left: -5px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
        }

        .vertical_arrow::after {
            content: '';
            position: absolute;
            top: -14px;
            left: -5px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
        }
        .green_arrow_lie::after{
            border-left: 20px solid limegreen;
        }
        .green_arrow_lie::before{
            border-right: 20px solid limegreen;
        }
        .green_arrow_up::before {
            border-top: 20px solid limegreen;
        }

        .green_arrow_up::after {
            border-bottom: 20px solid limegreen;
        }

        .red_arrow_up::before {
            border-top: 20px solid red;
        }

        .red_arrow_up::after {
            border-bottom: 20px solid red;
        }
        .red_arrow_lie::after {
            border-left: 20px solid red;
        }
        .red_arrow_lie::before {
            border-right: 20px solid red;
        }
        #request_btn {
            position: relative;
            z-index: 1000;
        }
        #expand-btn {
            position: absolute;
            z-index: 1500;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #info {
            position: relative;
            top: -25px;
        }
        
    </style>
</head>
<body>
    <header>
        <div id="menu-btn">☰</div>
        <h1 style="font-size: 19px;">リアルタイム信号機マップ</h1>
    </header>
    <div id="map"></div>
    <button id="locateMe">現在位置を表示</button>
    <div id="signal-info">
        <button id="expand-btn">拡大</button>
        <button class="start-btn" style="width:60px; font-size: 10px; position: relative; top: 4%; left: 33%; z-index: 1000;">Start compass</button>
        <p id="info"></p>
        <div class="arrow-container">
            <div class="horizontal_arrow" id="arrow_lie"></div>    
            <div class="vertical_arrow" id="arrow_up"></div>
            <p id="display_second_lie"></p>
            <p id="display_second_up"></p>
        </div>
    </div>
    <script>
        // 既存のJavaScriptコードをここに配置し、以下の変更を加えます

        const compassCircle = document.querySelector(".arrow-container");
        const startBtn = document.querySelector(".start-btn");
        const isIOS =
            navigator.userAgent.match(/(iPod|iPhone|iPad)/) &&
            navigator.userAgent.match(/AppleWebKit/);
        function init() {
            startBtn.addEventListener("click", startCompass);

            if (!isIOS) {
                window.addEventListener("deviceorientationabsolute", handler, true);
            }
        }

        function handleOrientation(event) {
            let direction;
            if (event.webkitCompassHeading) {
                // iOS devices
                direction = event.webkitCompassHeading;
            } else if (event.absolute === true && event.alpha !== null) {
                // Android devices
                direction = 360 - event.alpha;
            } else {
                console.log("Compass not supported");
                return;
            }
            compassCircle.style.transform = `rotate(${direction}deg)`;
        }

        var kanagawaCenter = [35.4478, 139.6425];
        var map = L.map('map').setView(kanagawaCenter, 10);
        var markers = L.layerGroup().addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var kanagawaBounds = L.latLngBounds(
            [35.1331, 138.9270],
            [35.6636, 139.8229]
        );

        map.setMaxBounds(kanagawaBounds);
        map.on('drag', function() {
            map.panInsideBounds(kanagawaBounds, { animate: false });
        });

        var markers = L.layerGroup().addTo(map);

function loadTrafficSignals() {
    if (map.getZoom() < 16) {
        markers.clearLayers();
        return;
    }

    var bounds = map.getBounds();
    var overpassQuery = `
        [out:json];
        area["name"="神奈川県"]->.searchArea;
        (
        node["highway"="traffic_signals"]
            (${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()})
            (area.searchArea);
        );
        out body;
    `;

    fetch('https://overpass-api.de/api/interpreter', {
        method: 'POST',
        body: 'data=' + encodeURIComponent(overpassQuery)
    })
    .then(response => response.json())
    .then(data => {
        markers.clearLayers();
        
        // マーカーをグループ化する
        let groups = groupMarkers(data.elements);
        
        // 各グループの中心にマーカーを配置
        // 各グループの中心にマーカーを配置
        // 各グループの中心にマーカーを配置
        groups.forEach(group => {
            let centerLat = group.reduce((sum, node) => sum + node.lat, 0) / group.length;
            let centerLon = group.reduce((sum, node) => sum + node.lon, 0) / group.length;
            let id = group[0].id;

            // 各ノードの name タグを確認し、存在するものを使用する
            let name = null;
            for (let node of group) {
                if (node.tags?.name) {
                    name = node.tags.name;
                    break;
                }
            }

            let popup = L.popup()
                .setLatLng([centerLat, centerLon])
                .setContent(`
                    <h3>交差点情報</h3>
                    <p>ID: ${id}</p>
                    <p>名称: ${name || '不明'}</p>
                    <p>緯度: ${centerLat.toFixed(6)}</p>
                    <p>経度: ${centerLon.toFixed(6)}</p>
                    <p>グループ内の信号数: ${group.length}</p>
                `);

            L.circleMarker([centerLat, centerLon], {
                radius: 6,
                fillColor: "#ff7800",
                color: "#000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8,
                id: id,
                name: name // マーカーにも名称を設定
            }).addTo(markers)
            .bindPopup(popup)
            .on('click', onMarkerClick);
        });
    })
    .catch(error => console.error('Error:', error));
}

function groupMarkers(nodes) {
    const MAX_DISTANCE = 0.0008; // 約11メートル
    let groups = [];

    nodes.forEach(node => {
        let added = false;
        for (let group of groups) {
            if (isClose(node, group[0], MAX_DISTANCE)) {
                group.push(node);
                added = true;
                break;
            }
        }
        if (!added) {
            groups.push([node]);
        }
    });

    return groups;
}

function isClose(node1, node2, maxDistance) {
    return Math.abs(node1.lat - node2.lat) < maxDistance && 
           Math.abs(node1.lon - node2.lon) < maxDistance;
}



let currentPositionMarker;

function showCurrentPosition() {
    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(function(position) {
            var lat = position.coords.latitude;
            var lon = position.coords.longitude;

            // 既存のマーカーを削除
            if (currentPositionMarker) {
                map.removeLayer(currentPositionMarker);
            }

            // 新しいマーカーを追加
            currentPositionMarker = L.marker([lat, lon]).addTo(map);
            currentPositionMarker.bindPopup("あなたの現在位置").openPopup();

            // マップの中心を現在位置に移動
            map.setView([lat, lon], 15);
        }, function(error) {
            console.error("位置情報の取得に失敗しました: ", error);
            var errorMessage;
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = "位置情報の使用が許可されていません。";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = "位置情報が利用できません。";
                    break;
                case error.TIMEOUT:
                    errorMessage = "位置情報の取得がタイムアウトしました。";
                    break;
                default:
                    errorMessage = "不明なエラーが発生しました。";
            }
            alert(errorMessage);
            // 代替手段として、デフォルトの位置を設定
            setDefaultPosition();
        }, {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        });
    } else {
        alert("お使いのブラウザは位置情報をサポートしていません。");
        setDefaultPosition();
    }
}

function setDefaultPosition() {
    // 神奈川県庁の位置をデフォルトとして設定
    var defaultLat = 35.4478;
    var defaultLon = 139.6425;
    currentPositionMarker = L.marker([defaultLat, defaultLon]).addTo(map);
    currentPositionMarker.bindPopup("デフォルト位置（神奈川県庁）").openPopup();
    map.setView([defaultLat, defaultLon], 15);
}

// ボタンにイベントリスナーを追加
document.getElementById('locateMe').addEventListener('click', showCurrentPosition);



        map.on('moveend', loadTrafficSignals);
        map.on('zoomend', loadTrafficSignals);

        

        loadTrafficSignals();


        count = 10;
        ratio = 1*100/count;
        // 1秒ごとにカウントダウンする関数
        arrow_up = document.getElementById("arrow_up")
        arrow_lie = document.getElementById("arrow_lie")
        green_north = 1
        arrow_lie.classList.add("green_arrow_lie")
        arrow_up.classList.add("red_arrow_up")
        change_color = 0
        function countDown() {
            console.log(count);
            if(green_north==1) {
                    arrow_up.style = `background: linear-gradient(antiquewhite ${100-count*ratio}%, red ${100-count*ratio}%);`;
                    arrow_lie.style = `background: linear-gradient(90deg, limegreen ${count*ratio}%, antiquewhite ${count*ratio}%);`;
                } else {
                    arrow_up.style = `background: linear-gradient(antiquewhite ${100-count*ratio}%, limegreen ${100-count*ratio}%);`;
                    arrow_lie.style = `background: linear-gradient(90deg, red ${count*ratio}%, antiquewhite ${count*ratio}%);`;
            }
            if (count <= 1) {
                green_north *= -1
                count = 11;
                change_color = 2;
            }
            if(change_color === 1) {
                if (green_north == 1){
                    arrow_lie.classList.remove("red_arrow_lie");
                    arrow_up.classList.remove("green_arrow_up");
                    arrow_lie.style = 'background: linear-gradient(90deg, limegreen 100%, antiquewhite 100%);'
                    arrow_up.style = 'background: linear-gradient(antiquewhite 0%, red 0%);'
                    arrow_lie.classList.add('green_arrow_lie');
                    arrow_up.classList.add("red_arrow_up");
                } else {
                    arrow_lie.classList.remove("green_arrow_lie");
                    arrow_up.classList.remove("red_arrow_up");
                    arrow_lie.style = 'background: linear-gradient(90deg, red 100%, antiquewhite 100%);'
                    arrow_up.style = 'background: linear-gradient(antiquewhite 0%, limegreen 0%);'
                    arrow_lie.classList.add('red_arrow_lie');
                    arrow_up.classList.add("green_arrow_up");
                }
            }
            timer = setTimeout(countDown, 1000);
            change_color --;
            count--;
        }

        // 初回実行
        let timer = setTimeout(countDown, 1000);


        // マーカークリック時の処理を変更
        function onMarkerClick(e) {
            let signalInfo = document.getElementById('signal-info');
            signalInfo.classList.add('active');
            signalInfo.classList.remove('full');

            // 交差点の情報を取得する
            let centerLat = e.latlng.lat;
            let centerLon = e.latlng.lng;
            let id = e.target.options.id;
            let name = e.target.options.name; // 信号機の名称を取得

            let info = `
                <h3>交差点情報</h3>
                <p>ID: ${id}</p>
                <p>名称: ${name || '不明'}</p> <!-- 名称がない場合は '不明' と表示 -->
                <p style=display:none;>緯度: ${centerLat.toFixed(6)}</p>
                <p style=display:none;>経度: ${centerLon.toFixed(6)}</p>
            `;

            // 交差点の情報を表示する
            let infoElement = document.getElementById('info');
            infoElement.innerHTML = info;
        }

        // 拡大ボタンの処理
        document.getElementById('expand-btn').addEventListener('click', function() {
            const signalInfo = document.getElementById('signal-info');
            
            // 'active' クラスが存在しない場合、まず下からスライドインさせる
            if (!signalInfo.classList.contains('active')) {
                signalInfo.classList.add('active');
            } else {
                // 'active' クラスが存在する場合は 'full' クラスをトグル
                signalInfo.classList.toggle('full');
            }
            
            // ボタンのテキストを変更
            this.textContent = signalInfo.classList.contains('full') ? '縮小' : '拡大';
        });

        // signal-info のクリックイベントを監視し、'active' クラスを削除
        document.getElementById('map').addEventListener('click', function() {
            const signalInfo = document.getElementById('signal-info');
            map_el = document.getElementById('map')
            
            // 'full' クラスがない状態でクリックされた場合、'active' クラスを削除
            if (signalInfo.classList.contains('active') && map_el.querySelector('h3') === null) {
                signalInfo.classList.remove('active');
            }
        });



        /*// マーカー作成時にクリックイベントを追加
        L.circleMarker([centerLat, centerLon], {
            // 既存のオプション
        }).addTo(markers)
        .bindPopup(popup)
        .on('click', onMarkerClick);*/

        // 地図の初期化後に現在位置ボタンを追加
        map.on('load', function() {
            var locateMeBtn = L.control({position: 'bottomright'});
            locateMeBtn.onAdd = function (map) {
                var div = L.DomUtil.get('locateMe');
                L.DomEvent.on(div, 'click', function (ev) {
                    L.DomEvent.stopPropagation(ev);
                    showCurrentPosition();
                });
                return div;
            };
            locateMeBtn.addTo(map);
        });
    </script>
</body>
</html>
